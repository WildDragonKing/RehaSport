name: Deploy & Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  deploy-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: site/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: site

      - name: Run tests
        run: npm test
        working-directory: site

      - name: Security Audit (Site)
        run: npm audit --audit-level=high
        working-directory: site
        continue-on-error: true

      - name: TypeScript Check (Functions)
        run: npm ci && npx tsc --noEmit
        working-directory: functions

      - name: Security Audit (Functions)
        run: npm audit --audit-level=high
        working-directory: functions
        continue-on-error: true

      - name: Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: Get Firebase Config
        id: firebase-config
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > /tmp/sa.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.json
          CONFIG=$(firebase apps:sdkconfig web --project rehasport-trainer --json)
          echo "api_key=$(echo $CONFIG | jq -r '.result.sdkConfig.apiKey')" >> $GITHUB_OUTPUT
          echo "auth_domain=$(echo $CONFIG | jq -r '.result.sdkConfig.authDomain')" >> $GITHUB_OUTPUT
          echo "project_id=$(echo $CONFIG | jq -r '.result.sdkConfig.projectId')" >> $GITHUB_OUTPUT
          echo "storage_bucket=$(echo $CONFIG | jq -r '.result.sdkConfig.storageBucket')" >> $GITHUB_OUTPUT
          echo "messaging_sender_id=$(echo $CONFIG | jq -r '.result.sdkConfig.messagingSenderId')" >> $GITHUB_OUTPUT
          echo "app_id=$(echo $CONFIG | jq -r '.result.sdkConfig.appId')" >> $GITHUB_OUTPUT
          echo "measurement_id=$(echo $CONFIG | jq -r '.result.sdkConfig.measurementId')" >> $GITHUB_OUTPUT
          rm /tmp/sa.json

      - name: Build
        run: npm run build
        working-directory: site
        env:
          PUBLIC_FIREBASE_API_KEY: ${{ steps.firebase-config.outputs.api_key }}
          PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ steps.firebase-config.outputs.auth_domain }}
          PUBLIC_FIREBASE_PROJECT_ID: ${{ steps.firebase-config.outputs.project_id }}
          PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ steps.firebase-config.outputs.storage_bucket }}
          PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ steps.firebase-config.outputs.messaging_sender_id }}
          PUBLIC_FIREBASE_APP_ID: ${{ steps.firebase-config.outputs.app_id }}
          PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ steps.firebase-config.outputs.measurement_id }}

      - name: Install Functions dependencies
        run: npm ci
        working-directory: functions

      - name: Build Functions
        run: npm run build
        working-directory: functions

      - name: Deploy to Firebase (Hosting + Functions + Rules)
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > /tmp/sa.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.json
          firebase deploy --project rehasport-trainer
          rm /tmp/sa.json

      - name: Get next version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          PATCH=$((PATCH + 1))
          echo "version=v${MAJOR}.${MINOR}.${PATCH}" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          generate_release_notes: true
