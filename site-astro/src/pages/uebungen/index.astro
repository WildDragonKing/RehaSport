---
import BaseLayout from '@layouts/BaseLayout.astro';
import Button from '@components/Button.astro';
import { exercises } from '@/lib/exercises';

const basePath = import.meta.env.BASE_URL || '/';

// Get unique values for filters
const allPhases = ['Aufw√§rmen', 'Hauptteil', 'Schwerpunkt', 'Ausklang'];
const allDifficulties = [...new Set(exercises.map(e => e.difficulty).filter(Boolean))].sort();
---

<BaseLayout title="√úbungsbibliothek" description="Alle dokumentierten √úbungen mit Alternativen f√ºr Knie- und Schulterprobleme">
  <div class="container stack">
    <!-- Page Header with Search -->
    <header class="stack-sm">
      <h1>√úbungsbibliothek</h1>
      <p class="text-muted" style="max-width: 600px">
        Alle dokumentierten √úbungen mit Alternativen f√ºr Knie- und Schulterprobleme.
      </p>
      <div style="max-width: 480px">
        <div class="search-input-wrapper">
          <span class="search-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
          </span>
          <input
            type="search"
            class="input search-input"
            placeholder="√úbung suchen..."
            data-search-input
          />
          <button type="button" class="btn btn-ghost btn-icon search-clear" data-search-clear hidden>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Filters -->
    <div class="filter-section" data-filters>
      <div class="filter-row">
        <span class="filter-label">Phase:</span>
        <div class="filter-chips">
          {allPhases.map((phase) => (
            <button
              type="button"
              class="chip"
              data-phase-filter={phase}
            >
              {phase}
            </button>
          ))}
        </div>
      </div>

      {allDifficulties.length > 0 && (
        <div class="filter-row">
          <span class="filter-label">Schwierigkeit:</span>
          <select class="input" style="max-width: 200px" data-difficulty-filter>
            <option value="">Alle</option>
            {allDifficulties.map((diff) => (
              <option value={diff}>{diff}</option>
            ))}
          </select>
        </div>
      )}

      <button type="button" class="btn btn-ghost btn-sm" data-clear-filters hidden>
        Filter zur√ºcksetzen
      </button>
    </div>

    <!-- Results Count -->
    <p class="text-muted" style="font-size: 0.875rem" data-results-count>
      {exercises.length} √úbungen gefunden
    </p>

    <!-- Exercises Grid -->
    <ul class="grid-exercises" aria-label="√úbungen" data-exercises-grid>
      {exercises.map((exercise) => (
        <li data-exercise data-title={exercise.title.toLowerCase()} data-summary={exercise.summary?.toLowerCase() || ''} data-area={exercise.area?.toLowerCase() || ''} data-focus={exercise.focus?.toLowerCase() || ''} data-difficulty={exercise.difficulty || ''} data-tags={exercise.tags.join(' ').toLowerCase()}>
          <article class="card card-hover card-body" style="height: 100%; display: flex; flex-direction: column">
            <header style="flex: 1">
              <h2 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem">
                <a href={`${basePath}uebungen/${exercise.slug}/`} style="color: var(--color-text)">
                  {exercise.title}
                </a>
              </h2>
              {exercise.summary && (
                <p class="text-muted" style="font-size: 0.9375rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden">
                  {exercise.summary}
                </p>
              )}
            </header>

            <dl style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-top: 1rem; font-size: 0.875rem">
              {exercise.area && (
                <div>
                  <dt class="text-light" style="font-size: 0.75rem">Bereich</dt>
                  <dd style="font-weight: 500">{exercise.area}</dd>
                </div>
              )}
              {exercise.focus && (
                <div>
                  <dt class="text-light" style="font-size: 0.75rem">Schwerpunkt</dt>
                  <dd style="font-weight: 500">{exercise.focus}</dd>
                </div>
              )}
              {exercise.duration && (
                <div>
                  <dt class="text-light" style="font-size: 0.75rem">Dauer</dt>
                  <dd style="font-weight: 500">{exercise.duration}</dd>
                </div>
              )}
              {exercise.difficulty && (
                <div>
                  <dt class="text-light" style="font-size: 0.75rem">Schwierigkeit</dt>
                  <dd style="font-weight: 500">{exercise.difficulty}</dd>
                </div>
              )}
            </dl>

            {exercise.tags.length > 0 && (
              <ul style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-top: 1rem">
                {exercise.tags.slice(0, 3).map((tag) => (
                  <li class="badge badge-primary">#{tag}</li>
                ))}
              </ul>
            )}

            <div style="margin-top: 1rem">
              <Button href={`${basePath}uebungen/${exercise.slug}/`} size="sm">
                Details ansehen
              </Button>
            </div>
          </article>
        </li>
      ))}
    </ul>

    <!-- Empty State -->
    <div class="empty-state" data-empty-state hidden>
      <div class="empty-state-icon">üîç</div>
      <h2 class="empty-state-title">Keine √úbungen gefunden</h2>
      <p class="empty-state-description">
        Versuche andere Suchbegriffe oder Filter.
      </p>
      <Button variant="ghost" data-reset-from-empty>
        Filter zur√ºcksetzen
      </Button>
    </div>
  </div>
</BaseLayout>

<script>
  const searchInput = document.querySelector<HTMLInputElement>('[data-search-input]');
  const searchClear = document.querySelector<HTMLButtonElement>('[data-search-clear]');
  const phaseFilters = document.querySelectorAll<HTMLButtonElement>('[data-phase-filter]');
  const difficultyFilter = document.querySelector<HTMLSelectElement>('[data-difficulty-filter]');
  const clearFiltersBtn = document.querySelector<HTMLButtonElement>('[data-clear-filters]');
  const resultsCount = document.querySelector('[data-results-count]');
  const exercisesGrid = document.querySelector('[data-exercises-grid]');
  const exercises = document.querySelectorAll<HTMLElement>('[data-exercise]');
  const emptyState = document.querySelector<HTMLElement>('[data-empty-state]');
  const resetFromEmpty = document.querySelector<HTMLButtonElement>('[data-reset-from-empty]');

  let query = '';
  let selectedPhases: string[] = [];
  let selectedDifficulty = '';

  function filterExercises() {
    const lowerQuery = query.toLowerCase();
    let visibleCount = 0;

    exercises.forEach((exercise) => {
      const title = exercise.dataset.title || '';
      const summary = exercise.dataset.summary || '';
      const area = exercise.dataset.area || '';
      const focus = exercise.dataset.focus || '';
      const difficulty = exercise.dataset.difficulty || '';
      const tags = exercise.dataset.tags || '';

      // Text search
      const matchesQuery = !query ||
        title.includes(lowerQuery) ||
        summary.includes(lowerQuery) ||
        area.includes(lowerQuery) ||
        focus.includes(lowerQuery) ||
        tags.includes(lowerQuery);

      // Phase filter (check if focus matches any selected phase)
      const matchesPhase = selectedPhases.length === 0 ||
        selectedPhases.some(phase => focus.includes(phase.toLowerCase()));

      // Difficulty filter
      const matchesDifficulty = !selectedDifficulty || difficulty === selectedDifficulty;

      const isVisible = matchesQuery && matchesPhase && matchesDifficulty;
      exercise.hidden = !isVisible;

      if (isVisible) visibleCount++;
    });

    // Update results count
    if (resultsCount) {
      resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? '√úbung' : '√úbungen'} gefunden`;
    }

    // Show/hide empty state
    if (exercisesGrid) exercisesGrid.classList.toggle('hidden', visibleCount === 0);
    if (emptyState) emptyState.hidden = visibleCount > 0;

    // Show/hide clear filters button
    const hasFilters = query || selectedPhases.length > 0 || selectedDifficulty;
    if (clearFiltersBtn) clearFiltersBtn.hidden = !hasFilters;
    if (searchClear) searchClear.hidden = !query;
  }

  function clearFilters() {
    query = '';
    selectedPhases = [];
    selectedDifficulty = '';

    if (searchInput) searchInput.value = '';
    if (difficultyFilter) difficultyFilter.value = '';

    phaseFilters.forEach((btn) => {
      btn.classList.remove('chip-active');
    });

    filterExercises();
  }

  // Search input
  searchInput?.addEventListener('input', (e) => {
    query = (e.target as HTMLInputElement).value;
    filterExercises();
  });

  // Search clear
  searchClear?.addEventListener('click', () => {
    query = '';
    if (searchInput) searchInput.value = '';
    filterExercises();
  });

  // Phase filters
  phaseFilters.forEach((btn) => {
    btn.addEventListener('click', () => {
      const phase = btn.dataset.phaseFilter || '';
      const index = selectedPhases.indexOf(phase);

      if (index > -1) {
        selectedPhases.splice(index, 1);
        btn.classList.remove('chip-active');
      } else {
        selectedPhases.push(phase);
        btn.classList.add('chip-active');
      }

      filterExercises();
    });
  });

  // Difficulty filter
  difficultyFilter?.addEventListener('change', (e) => {
    selectedDifficulty = (e.target as HTMLSelectElement).value;
    filterExercises();
  });

  // Clear filters buttons
  clearFiltersBtn?.addEventListener('click', clearFilters);
  resetFromEmpty?.addEventListener('click', clearFilters);

  // Add hidden class for grid
  const style = document.createElement('style');
  style.textContent = '.hidden { display: none !important; }';
  document.head.appendChild(style);
</script>
