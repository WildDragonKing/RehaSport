---
import BaseLayout from '@layouts/BaseLayout.astro';
import Button from '@components/Button.astro';
import { categories, getCategory, getSession } from '@/lib/sessions';
import { findExerciseSlugByTitle } from '@/lib/exercises';

export function getStaticPaths() {
  return categories.flatMap((category) =>
    category.sessions.map((session) => ({
      params: {
        categorySlug: category.slug,
        sessionSlug: session.slug,
      },
    }))
  );
}

const { categorySlug, sessionSlug } = Astro.params;
const session = getSession(categorySlug, sessionSlug);
const category = getCategory(categorySlug);
const basePath = import.meta.env.BASE_URL || '/';

if (!session || !category) {
  return Astro.redirect(basePath);
}

function getPhaseColorClass(phaseTitle: string): string {
  const title = phaseTitle.toLowerCase();
  if (title.includes("aufwÃ¤rmen") || title.includes("phase 1")) return "phase-warmup";
  if (title.includes("hauptteil") || title.includes("phase 2")) return "phase-main";
  if (title.includes("schwerpunkt") || title.includes("phase 3")) return "phase-focus";
  if (title.includes("ausklang") || title.includes("phase 4")) return "phase-cooldown";
  return "";
}

const allExercises = session.phases.flatMap((phase, phaseIndex) =>
  phase.exercises.map((exercise, exerciseIndex) => ({
    exercise,
    key: `${phaseIndex}-${exerciseIndex}`,
    phaseTitle: phase.title,
    phaseIndex,
    exerciseIndex
  }))
);
---

<BaseLayout title={session.title} description={session.description}>
  <div class="container stack" style="padding-bottom: 100px" data-session-container>
    <!-- Breadcrumb -->
    <nav class="breadcrumb" aria-label="Navigation">
      <a href={basePath} class="breadcrumb-link">Start</a>
      <span class="breadcrumb-separator">/</span>
      <a href={`${basePath}ordner/${category.slug}/`} class="breadcrumb-link">{category.title}</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current">{session.title}</span>
    </nav>

    <!-- Page Header -->
    <header class="stack-sm">
      <h1>{session.title}</h1>
      {session.description && (
        <p class="text-muted" style="font-size: 1.125rem">
          {session.description}
        </p>
      )}

      <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-top: 0.5rem">
        {session.duration && (
          <div>
            <span class="text-light" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em">Dauer</span>
            <p style="font-weight: 500">{session.duration}</p>
          </div>
        )}
        {session.focus && (
          <div>
            <span class="text-light" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em">Fokus</span>
            <p style="font-weight: 500">{session.focus}</p>
          </div>
        )}
      </div>
    </header>

    <!-- Phase Timeline -->
    {session.phases.length > 0 && (
      <div class="phase-timeline" data-phase-timeline>
        <div class="phase-timeline-segment warmup" data-phase="0"></div>
        <div class="phase-timeline-segment main" data-phase="1"></div>
        <div class="phase-timeline-segment focus" data-phase="2"></div>
        <div class="phase-timeline-segment cooldown" data-phase="3"></div>
      </div>
    )}

    <!-- Session Controls -->
    {session.phases.length > 0 && allExercises.length > 0 && (
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem">
        <button type="button" class="btn btn-ghost btn-sm" data-toggle-all>
          Alle aufklappen
        </button>
        <span class="text-muted" style="font-size: 0.875rem; font-weight: 500" data-exercise-counter>
          1 / {allExercises.length}
        </span>
      </div>
    )}

    <!-- Session Phases -->
    {session.phases.length > 0 ? (
      <div class="accordion" data-accordion>
        {session.phases.map((phase, phaseIndex) => {
          const phaseColorClass = getPhaseColorClass(phase.title);
          return (
            <section class={`phase-indicator ${phaseColorClass}`} style="padding: 0; border-radius: var(--radius-xl); overflow: hidden">
              <div style="padding: 1rem 1.25rem; border-bottom: 1px solid var(--color-border-light)">
                <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0">{phase.title}</h2>
                {phase.description && (
                  <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.25rem">
                    {phase.description}
                  </p>
                )}
              </div>

              <ol style="list-style: none; padding: 0; margin: 0">
                {phase.exercises.map((exercise, exerciseIndex) => {
                  const exerciseKey = `${phaseIndex}-${exerciseIndex}`;
                  const globalIndex = allExercises.findIndex(e => e.key === exerciseKey);
                  const exerciseSlug = findExerciseSlugByTitle(exercise.title);
                  const primaryDetail = exercise.details.find((d) => d.label === "DurchfÃ¼hrung");
                  const otherDetails = exercise.details.filter((d) => d.label !== "DurchfÃ¼hrung");
                  const kneeDetail = otherDetails.find((d) => d.label === "Knie-Alternative");
                  const shoulderDetail = otherDetails.find((d) => d.label === "Schulter-Alternative");

                  return (
                    <li
                      class="accordion-item"
                      data-accordion-item
                      data-key={exerciseKey}
                      data-global-index={globalIndex}
                      data-phase-index={phaseIndex}
                      style={`border: none; border-radius: 0; ${exerciseIndex > 0 ? 'border-top: 1px solid var(--color-border-light)' : ''}`}
                    >
                      <button
                        type="button"
                        class="accordion-header"
                        data-accordion-trigger
                        aria-expanded="false"
                      >
                        <div class="accordion-header-content">
                          <span style="display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background-color: var(--color-surface-muted); font-size: 0.875rem; font-weight: 600; flex-shrink: 0">
                            {exerciseIndex + 1}
                          </span>
                          <div style="min-width: 0">
                            <span class="accordion-header-title">{exercise.title}</span>
                            {primaryDetail && (
                              <span class="text-muted" style="display: block; font-size: 0.875rem; margin-top: 0.125rem">
                                {primaryDetail.value}
                              </span>
                            )}
                          </div>
                        </div>

                        <div class="accordion-header-meta">
                          {kneeDetail && (
                            <span class="badge badge-knee" title="Knie-Alternative">ðŸ¦µ</span>
                          )}
                          {shoulderDetail && (
                            <span class="badge badge-shoulder" title="Schulter-Alternative">ðŸ’ª</span>
                          )}
                          <span class="accordion-chevron">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="m6 9 6 6 6-6" />
                            </svg>
                          </span>
                        </div>
                      </button>

                      <div class="accordion-content" data-accordion-content hidden>
                        {otherDetails.length > 0 && (
                          <div class="stack-sm">
                            {otherDetails.map((detail) => (
                              <div
                                class={detail.label.includes("Alternative") ? "alternative-card" : "quick-info-card"}
                                style={detail.label.includes("Knie") ? "background-color: var(--color-secondary-soft)" : detail.label.includes("Schulter") ? "background-color: var(--color-phase-focus-bg)" : ""}
                              >
                                <div class="quick-info-card-title">{detail.label}</div>
                                <div class="quick-info-card-content">{detail.value}</div>
                              </div>
                            ))}
                          </div>
                        )}
                        {exerciseSlug && (
                          <div style="margin-top: 1rem">
                            <Button href={`${basePath}uebungen/${exerciseSlug}/`} variant="ghost" size="sm">
                              Zur vollstÃ¤ndigen Ãœbung â†’
                            </Button>
                          </div>
                        )}
                      </div>
                    </li>
                  );
                })}
              </ol>
            </section>
          );
        })}
      </div>
    ) : (
      <p class="text-muted">Keine Ãœbungen in dieser Stunde gefunden.</p>
    )}

    <!-- Sticky Bottom Navigation -->
    {allExercises.length > 1 && (
      <div class="bottom-nav" data-bottom-nav>
        <div class="bottom-nav-content">
          <button
            type="button"
            class="btn btn-ghost btn-icon"
            data-nav-prev
            aria-label="Vorherige Ãœbung"
            disabled
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6" />
            </svg>
          </button>

          <div class="bottom-nav-center" data-nav-dots>
            <span class="bottom-nav-dot active" style="background-color: var(--color-phase-warmup)" data-nav-dot="0"></span>
            <span class="bottom-nav-dot" style="background-color: var(--color-phase-main)" data-nav-dot="1"></span>
            <span class="bottom-nav-dot" style="background-color: var(--color-phase-focus)" data-nav-dot="2"></span>
            <span class="bottom-nav-dot" style="background-color: var(--color-phase-cooldown)" data-nav-dot="3"></span>
          </div>

          <button
            type="button"
            class="btn btn-ghost btn-icon"
            data-nav-next
            aria-label="NÃ¤chste Ãœbung"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m9 18 6-6-6-6" />
            </svg>
          </button>
        </div>
      </div>
    )}
  </div>
</BaseLayout>

<script>
  // Session Page Interactivity
  const container = document.querySelector('[data-session-container]');
  if (!container) throw new Error('Session container not found');

  const accordion = container.querySelector('[data-accordion]');
  const items = container.querySelectorAll<HTMLElement>('[data-accordion-item]');
  const toggleAllBtn = container.querySelector<HTMLButtonElement>('[data-toggle-all]');
  const counter = container.querySelector('[data-exercise-counter]');
  const prevBtn = container.querySelector<HTMLButtonElement>('[data-nav-prev]');
  const nextBtn = container.querySelector<HTMLButtonElement>('[data-nav-next]');
  const navDots = container.querySelectorAll<HTMLElement>('[data-nav-dot]');
  const timelineSegments = container.querySelectorAll<HTMLElement>('[data-phase-timeline] > div');

  let currentIndex = 0;
  const totalExercises = items.length;

  function getPhaseIndex(phaseTitle: string): number {
    if (!phaseTitle) return -1;
    const title = phaseTitle.toLowerCase();
    if (title.includes("aufwÃ¤rmen") || title.includes("phase 1")) return 0;
    if (title.includes("hauptteil") || title.includes("phase 2")) return 1;
    if (title.includes("schwerpunkt") || title.includes("phase 3")) return 2;
    if (title.includes("ausklang") || title.includes("phase 4")) return 3;
    return -1;
  }

  function updateUI() {
    // Update counter
    if (counter) {
      counter.textContent = `${currentIndex + 1} / ${totalExercises}`;
    }

    // Update nav buttons
    if (prevBtn) prevBtn.disabled = currentIndex === 0;
    if (nextBtn) nextBtn.disabled = currentIndex === totalExercises - 1;

    // Get current phase
    const currentItem = items[currentIndex];
    const phaseIndex = currentItem ? parseInt(currentItem.dataset.phaseIndex || '0') : 0;

    // Update nav dots
    navDots.forEach((dot, i) => {
      dot.classList.toggle('active', i === phaseIndex);
    });

    // Update timeline
    timelineSegments.forEach((segment, i) => {
      segment.classList.toggle('active', i === phaseIndex);
    });

    // Update active item background
    items.forEach((item, i) => {
      if (i === currentIndex) {
        item.style.backgroundColor = 'var(--color-primary-softer)';
      } else {
        item.style.backgroundColor = 'transparent';
      }
    });

    // Update toggle all button text
    if (toggleAllBtn) {
      const allExpanded = Array.from(items).every(item =>
        item.querySelector('[data-accordion-trigger]')?.getAttribute('aria-expanded') === 'true'
      );
      toggleAllBtn.textContent = allExpanded ? 'Alle zuklappen' : 'Alle aufklappen';
    }
  }

  function expandItem(item: HTMLElement) {
    const trigger = item.querySelector<HTMLButtonElement>('[data-accordion-trigger]');
    const content = item.querySelector<HTMLElement>('[data-accordion-content]');
    if (trigger && content) {
      trigger.setAttribute('aria-expanded', 'true');
      content.hidden = false;
      item.classList.add('expanded');
    }
  }

  function collapseItem(item: HTMLElement) {
    const trigger = item.querySelector<HTMLButtonElement>('[data-accordion-trigger]');
    const content = item.querySelector<HTMLElement>('[data-accordion-content]');
    if (trigger && content) {
      trigger.setAttribute('aria-expanded', 'false');
      content.hidden = true;
      item.classList.remove('expanded');
    }
  }

  function goToExercise(index: number) {
    if (index < 0 || index >= totalExercises) return;

    currentIndex = index;
    const item = items[currentIndex];

    // Expand the item
    expandItem(item);

    // Scroll into view
    setTimeout(() => {
      item.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);

    // Haptic feedback
    if ('vibrate' in navigator) {
      navigator.vibrate(10);
    }

    updateUI();
  }

  // Accordion click handlers
  items.forEach((item, index) => {
    const trigger = item.querySelector<HTMLButtonElement>('[data-accordion-trigger]');
    trigger?.addEventListener('click', () => {
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        collapseItem(item);
      } else {
        expandItem(item);
        if ('vibrate' in navigator) {
          navigator.vibrate(10);
        }
      }

      currentIndex = index;
      updateUI();
    });
  });

  // Toggle all button
  toggleAllBtn?.addEventListener('click', () => {
    const allExpanded = Array.from(items).every(item =>
      item.querySelector('[data-accordion-trigger]')?.getAttribute('aria-expanded') === 'true'
    );

    items.forEach(item => {
      if (allExpanded) {
        collapseItem(item);
      } else {
        expandItem(item);
      }
    });

    updateUI();
  });

  // Navigation buttons
  prevBtn?.addEventListener('click', () => goToExercise(currentIndex - 1));
  nextBtn?.addEventListener('click', () => goToExercise(currentIndex + 1));

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
      e.preventDefault();
      goToExercise(currentIndex + 1);
    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
      e.preventDefault();
      goToExercise(currentIndex - 1);
    }
  });

  // Initial state
  updateUI();
</script>
